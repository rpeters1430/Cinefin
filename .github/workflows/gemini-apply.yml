name: "âœ… Gemini Apply Patch + PR"

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write

concurrency:
  group: "${{ github.workflow }}-issue-${{ github.event.issue.number }}"
  cancel-in-progress: false

jobs:
  apply:
    if: >
      contains(github.event.comment.body, '@gemini-cli /apply') &&
      (github.event.comment.author_association == 'OWNER' ||
       github.event.comment.author_association == 'MEMBER' ||
       github.event.comment.author_association == 'COLLABORATOR')
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Find propose run + download patch artifact
        id: fetch_patch
        uses: actions/github-script@v8
        env:
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        with:
          script: |
            const issueNumber = Number(process.env.ISSUE_NUMBER);
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // Find recent workflow runs of "ðŸ§  Gemini Propose Fix" for this repo.
            // We'll take the newest run and look for our artifact name.
            const runs = await github.rest.actions.listWorkflowRunsForRepo({
              owner,
              repo,
              per_page: 30
            });

            const artifactName = `gemini-patch-issue-${issueNumber}`;

            for (const run of runs.data.workflow_runs) {
              // Skip runs that aren't completed successfully
              if (run.status !== "completed") continue;
              if (run.conclusion !== "success") continue;

              // List artifacts for this run
              const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
                owner,
                repo,
                run_id: run.id,
                per_page: 100
              });

              const match = artifacts.data.artifacts.find(a => a.name === artifactName);
              if (!match) continue;

              core.info(`Found artifact "${artifactName}" in run ${run.id}`);
              core.setOutput("artifact_id", String(match.id));
              core.setOutput("artifact_name", artifactName);
              core.setOutput("run_id", String(run.id));
              return;
            }

            core.setFailed(`Could not find artifact "${artifactName}". Make sure the propose workflow ran and uploaded it.`);

      - name: Download patch artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ steps.fetch_patch.outputs.artifact_name }}
          path: ./gemini_patch

      - name: Validate patch exists
        run: |
          set -euo pipefail
          ls -la ./gemini_patch
          if [ ! -f ./gemini_patch/gemini.patch ]; then
            echo "gemini.patch not found in artifact"
            exit 1
          fi
          echo "Patch size:"
          wc -c ./gemini_patch/gemini.patch

      - name: Apply patch
        run: |
          set -euo pipefail
          git apply ./gemini_patch/gemini.patch
          git status --porcelain

      - name: Create branch, commit, push
        env:
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          set -euo pipefail
          branch="gemini/fix-issue-${ISSUE_NUMBER}"
          git checkout -b "$branch"

          git add -A
          if git diff --cached --quiet; then
            echo "No changes to commit after applying patch."
            exit 1
          fi

          git commit -m "Fix: issue #${ISSUE_NUMBER}"
          git push -u origin "$branch"
          echo "branch=$branch" >> "$GITHUB_OUTPUT"
        id: push_branch

      - name: Create PR (links to issue)
        env:
          GH_TOKEN: ${{ github.token }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          BRANCH: ${{ steps.push_branch.outputs.branch }}
        run: |
          set -euo pipefail
          gh pr create \
            --title "Fix issue #${ISSUE_NUMBER}" \
            --body "Fixes #${ISSUE_NUMBER}" \
            --base "${{ github.event.repository.default_branch }}" \
            --head "${BRANCH}"

      - name: Comment back with PR link
        uses: actions/github-script@v8
        env:
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        with:
          script: |
            const issueNumber = Number(process.env.ISSUE_NUMBER);
            // Find the PR we just created (latest open PR from our branch prefix)
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: "open",
              per_page: 20
            });

            const pr = prs.data.find(p => (p.head.ref || "").startsWith(`gemini/fix-issue-${issueNumber}`));
            const prUrl = pr?.html_url || "(Could not auto-detect PR URL â€” check the Actions logs.)";

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `âœ… Opened PR: ${prUrl}`
            });
