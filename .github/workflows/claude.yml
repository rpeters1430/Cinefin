name: Claude

on:
  # Comment-based triggers: @claude, /fix, /review, /triage
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  pull_request_review:
    types: [submitted]
  # Auto-trigger on PR open/sync (review) and issue open (triage)
  pull_request:
    types: [opened, synchronize]
  issues:
    types: [opened]

jobs:
  claude:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read

    if: |
      (
        github.event_name == 'pull_request' &&
        github.event.pull_request.head.repo.fork == false
      ) ||
      github.event_name == 'issues' ||
      (
        github.event.sender.type == 'User' &&
        (
          contains(github.event.comment.body, '@claude') ||
          contains(github.event.review.body, '@claude') ||
          startsWith(github.event.comment.body, '/fix') ||
          startsWith(github.event.comment.body, '/review') ||
          startsWith(github.event.comment.body, '/triage')
        )
      )

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # --- Auto PR review (triggered by pull_request open/sync) ---
      - name: Auto PR Review
        if: github.event_name == 'pull_request'
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          use_sticky_comment: true
          claude_args: --max-turns 5
          prompt: |
            Review this pull request for the Cinefin Jellyfin Android client.

            Check for:
            - MVVM adherence (ViewModels expose StateFlow, no business logic in Composables)
            - Jellyfin SDK calls only through Repositories, never from ViewModels directly
            - ApiResult<T> used for all repository error handling
            - Hilt constructor injection (no field injection)
            - Unnecessary recompositions (unstable lambdas, missing remember/derivedStateOf)
            - Unique keys in LazyColumn/LazyRow items
            - Material 3 tokens used (no hardcoded colors)
            - SecureLogger used (never android.util.Log)
            - No auth tokens in URL parameters
            - Null safety and missing error handling

            Be concise. Label issues as Critical / Major / Minor.

      # --- Auto triage (triggered by issues opened) ---
      - name: Auto Triage
        if: github.event_name == 'issues'
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_args: --max-turns 3
          prompt: |
            Triage this new issue for the Cinefin Jellyfin Android client.

            1. Apply the most appropriate labels from the repo's existing label list
            2. Post a brief comment acknowledging the issue and clarifying anything ambiguous

            Keep it short — just label and a one or two sentence response.

      # --- /fix command ---
      - name: Fix Issue
        if: |
          (github.event_name == 'issue_comment' || github.event_name == 'pull_request_review_comment') &&
          startsWith(github.event.comment.body, '/fix') &&
          contains(fromJSON('["OWNER", "MEMBER", "COLLABORATOR"]'), github.event.comment.author_association)
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_args: --max-turns 20
          prompt: |
            Implement a fix for this issue in the Cinefin Jellyfin Android client.

            Additional context from user: ${{ github.event.comment.body }}

            Steps:
            1. Read the issue body and comments to understand the problem
            2. Search the codebase to find the relevant files
            3. Read the affected files carefully before making any changes
            4. Implement the minimal fix needed — don't refactor unrelated code
            5. Add or update unit tests if the fix involves ViewModel or Repository logic
            6. Create a branch named fix/issue-${{ github.event.issue.number }}-short-description
            7. Commit using Conventional Commits format (fix: ...)
            8. Open a pull request referencing "Fixes #${{ github.event.issue.number }}"
            9. Post a comment on the issue summarizing what was done and linking to the PR

            Architecture rules (must follow):
            - ViewModels expose StateFlow, UI collects with collectAsStateWithLifecycle()
            - All Jellyfin SDK calls through Repositories in data/repository/ only
            - Repositories return ApiResult<T> (never throw directly)
            - Hilt constructor injection only
            - SecureLogger only (never android.util.Log)
            - Auth via Authorization header, never URL parameters
            - Kotlin 2.3.x, Compose BOM 2026.01.01, Material 3 Expressive
            - 4-space indent, 120 char line limit, Conventional Commits

            If the issue is unclear, post a comment asking for clarification instead of guessing.

      # --- /review command ---
      - name: Review / Implementation Plan
        if: |
          (github.event_name == 'issue_comment' || github.event_name == 'pull_request_review_comment') &&
          startsWith(github.event.comment.body, '/review') &&
          contains(fromJSON('["OWNER", "MEMBER", "COLLABORATOR"]'), github.event.comment.author_association)
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_args: --max-turns 10
          prompt: |
            You've been asked to review or analyze something in the Cinefin Jellyfin Android client.

            Additional context: ${{ github.event.comment.body }}

            - If this is on a Pull Request: review the code changes for correctness, architecture, security, and test coverage
            - If this is on an Issue: analyze the issue and post a detailed implementation plan so a follow-up /fix can use it as a blueprint

            For implementation plans, include: affected files, step-by-step changes, architecture notes, and testing instructions.

      # --- /triage command ---
      - name: Manual Triage
        if: |
          github.event_name == 'issue_comment' &&
          startsWith(github.event.comment.body, '/triage') &&
          contains(fromJSON('["OWNER", "MEMBER", "COLLABORATOR"]'), github.event.comment.author_association)
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_args: --max-turns 3
          prompt: |
            Triage this issue for the Cinefin Jellyfin Android client.
            Apply the most appropriate labels from the repo's existing label list.
            Post a brief comment if anything needs clarification.

      # --- @claude mention (general assistant) ---
      - name: Claude Assistant
        if: |
          (
            github.event_name == 'issue_comment' ||
            github.event_name == 'pull_request_review_comment' ||
            github.event_name == 'pull_request_review'
          ) &&
          (
            contains(github.event.comment.body, '@claude') ||
            contains(github.event.review.body, '@claude')
          )
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_args: --max-turns 10
          custom_instructions: |
            This is the Cinefin Jellyfin Android client (Jetpack Compose + Material 3 + Kotlin MVVM).
            MVVM architecture, Hilt DI, Repositories return ApiResult<T>, SecureLogger for logging,
            Kotlin 2.3.x, Compose BOM 2026.01.01, Material 3 Expressive, Conventional Commits.
