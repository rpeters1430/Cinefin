name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  claude-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1  # Upgraded from @beta
        with:
          # API key billing - separate from your Pro subscription
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

          # Sticky comment: Claude reuses the same comment on subsequent pushes
          use_sticky_comment: true

          claude_args: |
            --max-turns 5

          direct_prompt: |
            Please review this pull request for the Cinefin Jellyfin Android client and provide feedback on:

            **Architecture & Patterns**
            - MVVM adherence (ViewModels expose StateFlow, no business logic in Composables)
            - Jellyfin SDK calls only through Repositories (never direct from ViewModels)
            - ApiResult<T> used for error handling in repositories
            - Hilt constructor injection used correctly

            **Compose & UI**
            - Unnecessary recompositions (unstable lambdas, missing remember/derivedStateOf)
            - LaunchedEffect / DisposableEffect used correctly
            - Unique keys in LazyColumn/LazyRow items
            - Material 3 tokens used (no hardcoded colors)

            **Security**
            - SecureLogger used (never android.util.Log)
            - No auth tokens in URL parameters (use Authorization headers)
            - No hardcoded secrets or credentials

            **General**
            - Kotlin null safety
            - Missing error handling or edge cases
            - Test coverage for new logic

            Be concise and constructive. Flag Critical/Major/Minor issues clearly.
